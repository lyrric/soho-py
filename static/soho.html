<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOHO 搜货</title>
    <script src="js/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-title {
            text-align: center;
            margin-bottom: 30px;
            color: #1890ff;
            font-weight: 600;
        }

        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        .el-form-item {
            margin-bottom: 20px;
        }

        .btn-submit {
            width: 100%;
        }

        .operation-buttons {
            display: flex;
            gap: 5px;
        }

        /* 动画效果 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity .5s;
        }

        .fade-enter, .fade-leave-to {
            opacity: 0;
        }

        /* 导航栏样式 */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .nav-links li {
            margin: 0;
        }

        .nav-links a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: #606266;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .nav-links a:hover {
            color: #1890ff;
            border-bottom-color: #1890ff;
        }

        .nav-links a.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <!-- 导航栏 -->
    <div class="navbar">
        <ul class="nav-links">
            <li><a href="soho.html" class="active"><i class="fa fa-clock-o" aria-hidden="true"></i> SOHO 搜货</a></li>
            <li><a href="list.html"><i class="fa fa-list" aria-hidden="true"></i> 商品列表</a></li>
            <li style="margin-left: auto;">
                <el-button type="primary" @click="showTokenDialog" size="small" style="margin-top: 10px;">
                    <i class="fa fa-cog" aria-hidden="true"></i> 配置Token
                </el-button>
            </li>
        </ul>
    </div>
    <h1 class="app-title">
        <i class="fa fa-clock-o" aria-hidden="true"></i> SOHO 搜货
    </h1>


    <!-- 表格区域 -->
    <div class="table-container">
        <el-table
                :data="tableData"
                border
                stripe
                style="width: 100%"
                :loading="tableLoading">
            <el-table-column prop="task_id" label="TASK_ID" width="80" align="center"></el-table-column>
            <el-table-column prop="product_name" label="NAME" align="center"></el-table-column>
            <el-table-column prop="free_card_num" label="免单卡数量" width="120" align="center"></el-table-column>
            <el-table-column
                    prop="start_time"
                    label="开始时间"
                    align="center"
                    width="120">
                <template slot-scope="scope">{{ scope.row.start_time }}:00</template>
            </el-table-column>
            <el-table-column
                    prop="status"
                    label="状态"
                    align="center"
                    width="120">
                <template slot-scope="scope">
                    <el-tag :type="getStatusType(scope.row.status)">{{ getStatusText(scope.row.status) }}</el-tag>
                </template>
            </el-table-column>
            <el-table-column label="操作" align="center" width="200">
                <template slot-scope="scope">
                    <div class="operation-buttons">
                        <el-button
                                size="mini"
                                type="primary"
                                @click="handleEdit(scope.row)">
                            <i class="fa fa-pencil" aria-hidden="true"></i> 修改
                        </el-button>
                        <el-button
                                size="mini"
                                type="danger"
                                @click="handleDelete(scope.row.task_id)">
                            <i class="fa fa-trash" aria-hidden="true"></i> 删除
                        </el-button>
                    </div>
                </template>
            </el-table-column>
        </el-table>
    </div>

    <!-- 修改对话框 -->
    <el-dialog
            title="修改记录"
            :visible.sync="dialogVisible"
            width="500px"
            :close-on-click-modal="false">
        <el-form ref="editForm" :model="editForm" :rules="rules" label-width="120px" size="medium">
            <el-form-item label="Token ID" prop="token_id">
                <el-input v-model="editForm.token_id" placeholder="请输入Token ID"></el-input>
            </el-form-item>

            <el-form-item label="Product ID" prop="product_id">
                <el-input v-model="editForm.product_id" placeholder="请输入Product ID"></el-input>
            </el-form-item>

        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitEditForm" :loading="editLoading">确认</el-button>
        </div>
    </el-dialog>
    <!-- Token配置对话框 -->
    <el-dialog
            title="配置Token"
            :visible.sync="tokenDialogVisible"
            width="500px"
            :close-on-click-modal="false">
        <el-form ref="tokenForm" :model="tokenForm" :rules="tokenRules" label-width="120px" size="medium">
            <el-form-item label="Token ID" prop="token_id">
                <el-input v-model="tokenForm.token_id" placeholder="请输入Token ID"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="tokenDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitTokenForm" :loading="tokenLoading">确认</el-button>
        </div>
    </el-dialog>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                tokenDialogVisible: false,
                // 表单数据
                form: {
                    product_id: '',
                    token_id: '',
                    start_time: ''
                },
                // 编辑表单数据
                editForm: {
                    task_id: '',
                    product_id: '',
                    token_id: '',
                    start_time: ''
                },
                // Token表单数据
                tokenForm: {
                    token_id: ''
                },
                tokenLoading: false,
                // 表格数据
                tableData: [],
                // 小时选项
                hours: Array.from({length: 19}, (_, i) => i + 6), // 6到24
                // 对话框显示状态
                dialogVisible: false,
                // 加载状态
                loading: false,
                editLoading: false,
                tableLoading: false,
                // 表单验证规则
                rules: {
                    product_id: [
                        {required: true, message: '请输入Product ID', trigger: 'blur'}
                    ],
                    token_id: [
                        {required: true, message: '请输入Token ID', trigger: 'blur'}
                    ],
                    start_time: [
                        {required: true, message: '请选择开始时间', trigger: 'change'}
                    ],
                },
                // Token表单验证规则
                tokenRules: {
                    token_id: [
                        {required: true, message: '请输入Token ID', trigger: 'blur'}
                    ]
                }
            };
        },
        created() {
            // 页面加载时获取数据
            this.fetchData();
        },
        methods: {
            // 获取表格数据
            async fetchData() {
                this.tableLoading = true;
                try {
                    const response = await fetch('/soho/tasks/getList', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    const result = await response.json();
                    if (result.code === 200) {
                        this.tableData = (result.data || []).map(item => ({
                            task_id: item.task_id,
                            product_id: item.product_id,
                            product_name: item.product_name,
                            free_card_num: item.free_card_num,
                            token_id: item.token_id,
                            start_time: item.start_time,
                            status: item.status
                        }));
                    } else {
                        this.$message.error('获取数据失败: ' + result.msg);
                    }
                } catch (error) {
                    console.error('获取数据失败:', error);
                    this.$message.error('获取数据失败，请检查网络连接');
                } finally {
                    this.tableLoading = false;
                }
            },

            // 提交表单（新增）
            async submitForm() {
                const valid = await this.$refs.form.validate().catch(() => false);
                if (valid) {
                    this.loading = true;
                    try {
                        const response = await fetch('/soho/tasks/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                token_id: this.form.token_id,
                                product_id: this.form.product_id,
                                start_time: this.form.start_time
                            })
                        });
                        const result = await response.json();
                        if (result.code === 200) {
                            this.$message({
                                message: '新增成功',
                                type: 'success'
                            });
                            // 重置表单
                            this.$refs.form.resetFields();
                            // 刷新数据
                            this.fetchData();
                        } else {
                            this.$message.error('新增失败: ' + result.msg);
                        }
                    } catch (error) {
                        console.error('新增失败:', error);
                        this.$message.error('新增失败，请检查网络连接');
                    } finally {
                        this.loading = false;
                    }
                }
            },

            // 处理编辑
            handleEdit(row) {
                // 填充编辑表单
                this.editForm = {...row};
                this.dialogVisible = true;
            },

            // 提交编辑表单
            async submitEditForm() {
                const valid = await this.$refs.editForm.validate().catch(() => false);
                if (valid) {
                    this.editLoading = true;
                    try {
                        const response = await fetch(`/soho/tasks/${this.editForm.task_id}/update`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                token_id: this.editForm.token_id,
                                product_id: this.editForm.product_id,
                            })
                        });
                        const result = await response.json();
                        if (result.code === 200) {
                            this.$message({
                                message: '修改成功',
                                type: 'success'
                            });
                            // 关闭对话框并刷新数据
                            this.dialogVisible = false;
                            this.fetchData();
                        } else {
                            this.$message.error('修改失败: ' + result.msg);
                        }
                    } catch (error) {
                        console.error('修改失败:', error);
                        this.$message.error('修改失败，请检查网络连接');
                    } finally {
                        this.editLoading = false;
                    }
                }
            },

            // 处理删除
            handleDelete(task_id) {
                this.$confirm('确定要删除这条记录吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(async () => {
                    try {
                        const response = await fetch(`/soho/tasks/${task_id}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            }
                        });
                        const result = await response.json();
                        if (result.code === 200) {
                            this.$message({
                                type: 'success',
                                message: '删除成功!'
                            });
                            // 刷新数据
                            this.fetchData();
                        } else {
                            this.$message.error('删除失败: ' + result.msg);
                        }
                    } catch (error) {
                        console.error('删除失败:', error);
                        this.$message.error('删除失败，请检查网络连接');
                    }
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },

            // 获取CSRF Token
            getCsrfToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            },

            // 获取状态文字
            getStatusText(status) {
                const statusMap = {
                    '-1': '已取消',
                    '0': '初始状态',
                    '1': '成功',
                    '2': '失败'
                };
                return statusMap[status] || '未知状态';
            },

            // 获取状态标签类型
            getStatusType(status) {
                const typeMap = {
                    '-1': 'info',     // 已取消 - 灰色
                    '0': 'warning',   // 初始状态 - 橙色
                    '1': 'success',   // 成功 - 绿色
                    '2': 'danger'     // 失败 - 红色
                };
                return typeMap[status] || 'info';
            },
            // 显示Token配置对话框
            showTokenDialog() {
                this.tokenDialogVisible = true;
            },
            // 提交Token表单
            async submitTokenForm() {
                const valid = await this.$refs.tokenForm.validate().catch(() => false);
                if (valid) {
                    this.tokenLoading = true;
                    try {
                        const response = await fetch('/soho/set_token_id', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                token_id: this.tokenForm.token_id
                            })
                        });
                        if (response.ok) {
                            this.$message({
                                message: 'Token配置成功',
                                type: 'success'
                            });
                            // 关闭对话框
                            this.tokenDialogVisible = false;
                        } else {
                            this.$message.error('Token配置失败');
                        }
                    } catch (error) {
                        console.error('Token配置失败:', error);
                        this.$message.error('Token配置失败，请检查网络连接');
                    } finally {
                        this.tokenLoading = false;
                    }
                }
            },
        }
    });
</script>
</body>
</html>
